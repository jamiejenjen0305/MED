<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦ºçŸ¥æ£®æ—ï¼šå…«å¤§äººè¦ºä¿®è¡Œä¹‹æ—…</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React èˆ‡ Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- å¼•å…¥ Lucide åœ–æ¨™åº« -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@500;900&display=swap');
        
        body {
            margin: 0;
            background-color: #020617;
            font-family: 'Noto Serif TC', serif;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            /* é˜²æ­¢æ‰‹æ©Ÿæ‹‰å‹•é‡æ–°æ•´ç† */
            overscroll-behavior-y: contain;
        }

        /* ä½¿ç”¨ translate3d è§¸ç™¼ç¡¬é«”åŠ é€Ÿ */
        @keyframes firefly { 
            0%, 100% { transform: translate3d(0, 0, 0); opacity: 0.1; } 
            50% { transform: translate3d(20px, -30px, 0); opacity: 0.25; } 
        }
        @keyframes float-island { 
            0%, 100% { transform: translate3d(0, 0, 0); } 
            50% { transform: translate3d(0, -6px, 0); } 
        }
        @keyframes spin-slow { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.4; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        @keyframes glow-flow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translate3d(0, 0, 0); }
            25% { transform: translate3d(-3px, 0, 0); }
            75% { transform: translate3d(3px, 0, 0); }
        }
        /* æ–‡å­—è¢ç«èŸ²é£„å‹•å„ªåŒ– */
        @keyframes star-float {
            0% { transform: translate3d(0, 0, 0); }
            25% { transform: translate3d(30px, -40px, 0); }
            50% { transform: translate3d(-20px, 30px, 0); }
            75% { transform: translate3d(-40px, -15px, 0); }
            100% { transform: translate3d(0, 0, 0); }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .animate-firefly { animation: firefly 12s ease-in-out infinite; will-change: transform, opacity; }
        .animate-float-island { animation: float-island 6s ease-in-out infinite; will-change: transform; }
        .animate-spin-slow { animation: spin-slow 25s linear infinite; }
        .animate-pulse-ring { animation: pulse-ring 3s cubic-bezier(0.24, 0, 0.38, 1) infinite; }
        .animate-glow-flow { animation: glow-flow 4s ease-in-out infinite; }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        .animate-star-float { animation: star-float 15s ease-in-out infinite; will-change: transform; }
        .animate-twinkle { animation: twinkle var(--duration) ease-in-out infinite; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        .level-card {
            transition: transform 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67), filter 0.2s ease;
            -webkit-user-select: none;
            user-select: none;
        }
        .level-card:active {
            transform: scale(0.94) !important;
            filter: brightness(1.1);
        }

        /* é‡å°æ‰‹æ©Ÿå„ªåŒ–æ•ˆèƒ½ï¼šæ¸›å°‘æ¨¡ç³Šé‹ç®— */
        @media (max-width: 640px) {
            .blur-xl { filter: blur(12px); }
            .shadow-2xl { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo, memo } = React;

        const SCRIPTURE_INTRO = "ç‚ºä½›å¼Ÿå­ï¼Œå¸¸æ–¼æ™å¤œï¼Œè‡³å¿ƒèª¦å¿µï¼Œå…«å¤§äººè¦ºã€‚";

        const SCRIPTURE_EPILOGUE_GROUPS = [
            { id: "e1", phrases: ["å¦‚æ­¤å…«äº‹", "ä¹ƒæ˜¯è«¸ä½›", "è©è–©å¤§äºº", "ä¹‹æ‰€è¦ºæ‚Ÿ"], full: "å¦‚æ­¤å…«äº‹ï¼Œä¹ƒæ˜¯è«¸ä½›è©è–©å¤§äººä¹‹æ‰€è¦ºæ‚Ÿã€‚" },
            { id: "e2", phrases: ["ç²¾é€²è¡Œé“", "æ…ˆæ‚²ä¿®æ…§", "ä¹˜æ³•èº«èˆ¹", "è‡³æ¶…æ§ƒå²¸", "å¾©é‚„ç”Ÿæ­»", "åº¦è„«çœ¾ç”Ÿ"], full: "ç²¾é€²è¡Œé“ï¼Œæ…ˆæ‚²ä¿®æ…§ï¼Œä¹˜æ³•èº«èˆ¹ï¼Œè‡³æ¶…æ§ƒå²¸ï¼Œå¾©é‚„ç”Ÿæ­»ï¼Œåº¦è„«çœ¾ç”Ÿã€‚" },
            { id: "e3", phrases: ["ä»¥å‰å…«äº‹", "é–‹å°ä¸€åˆ‡", "ä»¤è«¸çœ¾ç”Ÿ", "è¦ºç”Ÿæ­»è‹¦", "æ¨é›¢äº”æ¬²", "ä¿®å¿ƒè–é“"], full: "ä»¥å‰å…«äº‹ï¼Œé–‹å°ä¸€åˆ‡ï¼Œä»¤è«¸çœ¾ç”Ÿï¼Œè¦ºç”Ÿæ­»è‹¦ï¼Œæ¨é›¢äº”æ¬²ï¼Œä¿®å¿ƒè–é“ã€‚" },
            { id: "e4", phrases: ["è‹¥ä½›å¼Ÿå­", "èª¦æ­¤å…«äº‹", "æ–¼å¿µå¿µä¸­", "æ»…ç„¡é‡ç½ª"], full: "è‹¥ä½›å¼Ÿå­ï¼Œèª¦æ­¤å…«äº‹ï¼Œæ–¼å¿µå¿µä¸­ï¼Œæ»…ç„¡é‡ç½ªã€‚" },
            { id: "e5", phrases: ["é€²è¶£è©æ", "é€Ÿç™»æ­£è¦º", "æ°¸æ–·ç”Ÿæ­»", "å¸¸ä½å¿«æ¨‚"], full: "é€²è¶£è©æï¼Œé€Ÿç™»æ­£è¦ºï¼›æ°¸æ–·ç”Ÿæ­»ï¼Œå¸¸ä½å¿«æ¨‚ã€‚" }
        ];

        const SCRIPTURE_OUTRO = `å¦‚æ­¤å…«äº‹ï¼Œä¹ƒæ˜¯è«¸ä½›è©è–©å¤§äººä¹‹æ‰€è¦ºæ‚Ÿï¼Œç²¾é€²è¡Œé“ï¼Œæ…ˆæ‚²ä¿®æ…§ï¼Œä¹˜æ³•èº«èˆ¹ï¼Œè‡³æ¶…æ§ƒå²¸ï¼Œå¾©é‚„ç”Ÿæ­»ï¼Œåº¦è„«çœ¾ç”Ÿã€‚ä»¥å‰å…«äº‹ï¼Œé–‹å°ä¸€åˆ‡ï¼Œä»¤è«¸çœ¾ç”Ÿï¼Œè¦ºç”Ÿæ­»è‹¦ï¼Œæ¨é›¢äº”æ¬²ï¼Œä¿®å¿ƒè–é“ã€‚è‹¥ä½›å¼Ÿå­ï¼Œèª¦æ­¤å…«äº‹ï¼Œæ–¼å¿µå¿µä¸­ï¼Œæ»…ç„¡é‡ç½ªï¼Œé€²è¶£è©æï¼Œé€Ÿç™»æ­£è¦ºï¼›æ°¸æ–·ç”Ÿæ­»ï¼Œå¸¸ä½å¿«æ¨‚ã€‚`;

        const LEVELS = [
            { id: 1, title: "ç¬¬ä¸€è¦ºæ‚Ÿ", subtitle: "ç„¡å¸¸è¦º", image: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬ä¸€è¦ºæ‚Ÿ", "ä¸–é–“ç„¡å¸¸", "åœ‹åœŸå±è„†", "å››å¤§è‹¦ç©º", "äº”é™°ç„¡æˆ‘", "ç”Ÿæ»…è®Šç•°", "è™›å½ç„¡ä¸»", "å¿ƒæ˜¯æƒ¡æº", "å½¢ç‚ºç½ªè—ª", "å¦‚æ˜¯è§€å¯Ÿ", "æ¼¸é›¢ç”Ÿæ­»"], full: "ç¬¬ä¸€è¦ºæ‚Ÿï¼Œä¸–é–“ç„¡å¸¸ï¼Œåœ‹åœŸå±è„†ï¼›å››å¤§è‹¦ç©ºï¼Œäº”é™°ç„¡æˆ‘ï¼Œç”Ÿæ»…è®Šç•°ï¼Œè™›å½ç„¡ä¸»ï¼›å¿ƒæ˜¯æƒ¡æºï¼Œå½¢ç‚ºç½ªè—ªï¼›å¦‚æ˜¯è§€å¯Ÿï¼Œæ¼¸é›¢ç”Ÿæ­»ã€‚", time: 100, bgm: "https://jamiejenjen0305.github.io/MED/8-1.mp3" },
            { id: 2, title: "ç¬¬äºŒè¦ºçŸ¥", subtitle: "å¤šæ¬²è¦º", image: "https://images.unsplash.com/photo-1513519245088-0e12902e5a38?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬äºŒè¦ºçŸ¥", "å¤šæ¬²ç‚ºè‹¦", "ç”Ÿæ­»ç–²å‹", "å¾è²ªæ¬²èµ·", "å°‘æ¬²ç„¡ç‚º", "èº«å¿ƒè‡ªåœ¨"], full: "ç¬¬äºŒè¦ºçŸ¥ï¼Œå¤šæ¬²ç‚ºè‹¦ï¼Œç”Ÿæ­»ç–²å‹ï¼Œå¾è²ªæ¬²èµ·ï¼Œå°‘æ¬²ç„¡ç‚ºï¼Œèº«å¿ƒè‡ªåœ¨ã€‚", time: 60, bgm: "https://jamiejenjen0305.github.io/MED/8-2.mp3" },
            { id: 3, title: "ç¬¬ä¸‰è¦ºçŸ¥", subtitle: "çŸ¥è¶³è¦º", image: "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬ä¸‰è¦ºçŸ¥", "å¿ƒç„¡å­è¶³", "æƒŸå¾—å¤šæ±‚", "å¢é•·ç½ªæƒ¡", "è©è–©ä¸çˆ¾", "å¸¸å¿µçŸ¥è¶³", "å®‰è²§å®ˆé“", "æƒŸæ…§æ˜¯æ¥­"], full: "ç¬¬ä¸‰è¦ºçŸ¥ï¼Œå¿ƒç„¡å­è¶³ï¼ŒæƒŸå¾—å¤šæ±‚ï¼Œå¢é•·ç½ªæƒ¡ï¼›è©è–©ä¸çˆ¾ï¼Œå¸¸å¿µçŸ¥è¶³ï¼Œå®‰è²§å®ˆé“ï¼ŒæƒŸæ…§æ˜¯æ¥­ã€‚", time: 80, bgm: "https://jamiejenjen0305.github.io/MED/8-3.mp3" },
            { id: 4, title: "ç¬¬å››è¦ºçŸ¥", subtitle: "ç²¾é€²è¦º", image: "https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬å››è¦ºçŸ¥", "æ‡ˆæ€ å¢œè½", "å¸¸è¡Œç²¾é€²", "ç ´ç…©æƒ±æƒ¡", "æ‘§ä¼å››é­”", "å‡ºé™°ç•Œç„"], full: "ç¬¬å››è¦ºçŸ¥ï¼Œæ‡ˆæ€ å¢œè½ï¼›å¸¸è¡Œç²¾é€²ï¼Œç ´ç…©æƒ±æƒ¡ï¼Œæ‘§ä¼å››é­”ï¼Œå‡ºé™°ç•Œç„ã€‚", time: 60, bgm: "https://jamiejenjen0305.github.io/MED/8-4.mp3" },
            { id: 5, title: "ç¬¬äº”è¦ºæ‚Ÿ", subtitle: "æ™ºæ…§è¦º", image: "https://images.unsplash.com/photo-1507499739999-097706ad8914?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬äº”è¦ºæ‚Ÿ", "æ„šç™¡ç”Ÿæ­»", "è©è–©å¸¸å¿µ", "å»£å­¸å¤šè", "å¢é•·æ™ºæ…§", "æˆå°±è¾¯æ‰", "æ•™åŒ–ä¸€åˆ‡", "æ‚‰ä»¥å¤§æ¨‚"], full: "ç¬¬äº”è¦ºæ‚Ÿï¼Œæ„šç™¡ç”Ÿæ­»ï¼Œè©è–©å¸¸å¿µï¼Œå»£å­¸å¤šèï¼Œå¢é•·æ™ºæ…§ï¼Œæˆå°±è¾¯æ‰ï¼Œæ•™åŒ–ä¸€åˆ‡ï¼Œæ‚‰ä»¥å¤§æ¨‚ã€‚", time: 80, bgm: "https://jamiejenjen0305.github.io/MED/8-5.mp3" },
            { id: 6, title: "ç¬¬å…­è¦ºçŸ¥", subtitle: "å¸ƒæ–½è¦º", image: "https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬å…­è¦ºçŸ¥", "è²§è‹¦å¤šæ€¨", "æ©«çµæƒ¡ç·£", "è©è–©å¸ƒæ–½", "ç­‰å¿µæ€¨è¦ª", "ä¸å¿µèˆŠæƒ¡", "ä¸æ†æƒ¡äºº"], full: "ç¬¬å…­è¦ºçŸ¥ï¼Œè²§è‹¦å¤šæ€¨ï¼Œæ©«çµæƒ¡ç·£ï¼›è©è–©å¸ƒæ–½ï¼Œç­‰å¿µæ€¨è¦ªï¼Œä¸å¿µèˆŠæƒ¡ï¼Œä¸æ†æƒ¡äººã€‚", time: 80, bgm: "https://jamiejenjen0305.github.io/MED/8-6.mp3" },
            { id: 7, title: "ç¬¬ä¸ƒè¦ºæ‚Ÿ", subtitle: "æ¢µè¡Œè¦º", image: "https://images.unsplash.com/photo-1518128958364-65859d70aa41?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬ä¸ƒè¦ºæ‚Ÿ", "äº”æ¬²éæ‚£", "é›–ç‚ºä¿—äºº", "ä¸æŸ“ä¸–æ¨‚", "å¸¸å¿µä¸‰è¡£", "ç“¦ç¼½æ³•å™¨", "å¿—é¡˜å‡ºå®¶", "å®ˆé“æ¸…ç™½", "æ¢µè¡Œé«˜é ", "æ…ˆæ‚²ä¸€åˆ‡"], full: "ç¬¬ä¸ƒè¦ºæ‚Ÿï¼Œäº”æ¬²éæ‚£ï¼›é›–ç‚ºä¿—äººï¼Œä¸æŸ“ä¸–æ¨‚ï¼Œå¸¸å¿µä¸‰è¡£, ç“¦ç¼½æ³•å™¨ï¼Œå¿—é¡˜å‡ºå®¶ï¼Œå®ˆé“æ¸…ç™½ï¼Œæ¢µè¡Œé«˜é ï¼Œæ…ˆæ‚²ä¸€åˆ‡ã€‚", time: 120, bgm: "https://jamiejenjen0305.github.io/MED/8-7.mp3" },
            { id: 8, title: "ç¬¬å…«è¦ºçŸ¥", subtitle: "å¤§å¿ƒè¦º", image: "https://images.unsplash.com/photo-1472396961693-142e6e269027?auto=format&fit=crop&q=80&w=400", scripture: ["ç¬¬å…«è¦ºçŸ¥", "ç”Ÿæ­»ç†¾ç„¶", "è‹¦æƒ±ç„¡é‡", "ç™¼å¤§ä¹˜å¿ƒ", "æ™®æ¿Ÿä¸€åˆ‡", "é¡˜ä»£çœ¾ç”Ÿ", "å—ç„¡é‡è‹¦", "ä»¤è«¸çœ¾ç”Ÿ", "ç•¢ç«Ÿå¤§æ¨‚"], full: "ç¬¬å…«è¦ºçŸ¥ï¼Œç”Ÿæ­»ç†¾ç„¶ï¼Œè‹¦æƒ±ç„¡é‡ï¼Œç™¼å¤§ä¹˜å¿ƒï¼Œæ™®æ¿Ÿä¸€åˆ‡ï¼›é¡˜ä»£çœ¾ç”Ÿï¼Œå—ç„¡é‡è‹¦ï¼›ä»¤è«¸çœ¾ç”Ÿï¼Œç•¢ç«Ÿå¤§æ¨‚ã€‚", time: 120, bgm: "https://jamiejenjen0305.github.io/MED/8-8.mp3" }
        ];

        const speakText = (text, onEnd) => {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 0.8;
            utterance.pitch = 0.95;
            const voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(v => v.lang.includes('zh-TW')) || voices.find(v => v.lang.includes('zh'));
            if (preferredVoice) utterance.voice = preferredVoice;
            utterance.onend = () => { if (onEnd) onEnd(); };
            window.speechSynthesis.speak(utterance);
        };

        // å„ªåŒ– Icon çµ„ä»¶ï¼Œä½¿ç”¨ React.memo æ¸›å°‘æ‰‹æ©Ÿç«¯é‡è¤‡æ¸²æŸ“é–‹éŠ·
        const Icon = memo(({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && lucide && lucide[name]) {
                    lucide.createIcons({
                        icons: { [name]: lucide[name] },
                        attrs: { width: size, height: size, class: className }
                    });
                }
            }, [name, size, className]);
            return <i ref={iconRef} data-lucide={name} className={className} style={{ display: 'inline-flex' }}></i>;
        });

        const StartScreen = ({ onStart }) => (
            <div className="flex-1 flex flex-col items-center justify-center p-6 text-center animate-in fade-in zoom-in duration-1000">
                <div className="relative mb-6 sm:mb-12">
                    <div className="w-40 h-40 sm:w-64 sm:h-64 rounded-[3rem] overflow-hidden border-4 border-emerald-400/30 bg-emerald-950/10">
                        <img src="https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?auto=format&fit=crop&q=80&w=800" className="w-full h-full object-cover opacity-80" alt="æ–°èŠ½" />
                    </div>
                    <div className="absolute -top-3 -right-3 sm:-top-8 sm:-right-8 bg-emerald-500/10 backdrop-blur-3xl p-3 sm:p-6 rounded-full border border-white/20 animate-spin-slow text-emerald-300">
                        <Icon name="Sparkles" size={28} />
                    </div>
                </div>
                <h1 className="text-4xl sm:text-6xl lg:text-8xl font-black mb-4 sm:mb-8 tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-emerald-200 via-emerald-400 to-teal-300">è¦ºçŸ¥å°å³¶</h1>
                <p className="text-base sm:text-xl lg:text-2xl text-slate-100 mb-6 sm:mb-8 font-light tracking-widest uppercase">è½ï¼Œé‚£æ˜¯å¤§åœ°çš„ä½èª</p>
                <div className="bg-white/10 backdrop-blur-md px-6 sm:px-10 py-3 sm:py-4 rounded-full border border-white/20 mb-8 sm:mb-14 animate-pulse mx-4">
                    <p className="text-emerald-300 text-xs sm:text-lg italic font-medium tracking-[0.2em]">{SCRIPTURE_INTRO}</p>
                </div>
                <button onClick={onStart} className="group bg-emerald-700 hover:bg-emerald-600 text-white px-10 sm:px-20 py-4 sm:py-7 rounded-full text-xl sm:text-3xl font-black shadow-2xl transition-all active:scale-90 flex items-center gap-4">
                    æ­¥å…¥æ£®æ— <Icon name="ChevronRight" size={24} className="group-hover:translate-x-2 transition-transform text-white" />
                </button>
            </div>
        );

        const MapView = ({ levels, collectedIds, onSelect, onOpenJournal, onFinal, isDedicationDone }) => (
            <div className="flex-1 flex flex-col p-4 sm:p-14 overflow-y-auto custom-scrollbar animate-in fade-in duration-500">
                <header className="mb-6 sm:mb-10 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div className="text-center sm:text-left">
                        <div className="inline-block px-4 py-1 bg-emerald-500/20 backdrop-blur-md border border-emerald-500/30 rounded-full text-[10px] sm:text-xs font-black text-emerald-300 mb-2 sm:mb-4 tracking-[0.3em] uppercase">ä¿®è¡Œä¹‹çœ¼</div>
                        <h2 className="text-3xl sm:text-5xl lg:text-6xl font-black tracking-widest text-white text-shadow-md">è«‹é¸æ“‡ä¿®è¡Œä¹‹å³¶</h2>
                    </div>
                    <div className="flex gap-2 sm:gap-4 w-full sm:w-auto justify-center">
                        <button onClick={onOpenJournal} className="flex-1 sm:flex-none group relative flex items-center justify-center gap-2 bg-emerald-950/60 px-4 sm:px-8 py-3 sm:py-5 rounded-2xl sm:rounded-[2.5rem] border border-emerald-500/40 transition-all active:scale-95">
                            <Icon name="BookOpen" size={20} className="text-emerald-400" />
                            <span className="text-sm sm:text-xl font-black text-emerald-100">æ™ºæ…§æ‰‹æœ­</span>
                            {isDedicationDone && <div className="absolute -top-1 -right-1 bg-amber-500 w-3 h-3 rounded-full animate-ping" />}
                        </button>
                        {collectedIds.length === 8 && (
                           <button onClick={onFinal} className={`flex-1 sm:flex-none group relative flex items-center justify-center gap-2 px-4 sm:px-8 py-3 sm:py-5 rounded-2xl sm:rounded-[2.5rem] shadow-2xl transition-all active:scale-95 ${isDedicationDone ? 'bg-white/10 border border-amber-500/30' : 'bg-amber-600 hover:bg-amber-500 animate-pulse'}`}>
                             <Icon name={isDedicationDone ? "Waves" : "Sparkles"} size={20} className={isDedicationDone ? "text-amber-400" : "text-white"} />
                             <span className={`text-sm sm:text-xl font-black ${isDedicationDone ? 'text-amber-200' : 'text-white'}`}>{isDedicationDone ? 'é‡æº«åœ“æ»¿' : 'åœ“æ»¿è¦ºçŸ¥'}</span>
                           </button>
                        )}
                    </div>
                </header>
                <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-10 mb-8">
                    {levels.map((lvl, idx) => (
                        <button key={lvl.id} onClick={() => onSelect(idx)} className={`level-card relative group flex flex-col items-center p-4 sm:p-8 rounded-[2rem] sm:rounded-[3.5rem] border-2 ${collectedIds.includes(lvl.id) ? 'bg-emerald-950/40 border-emerald-500/60 shadow-lg' : 'bg-white/5 border-white/10'}`} style={{ animation: `float-island ${6 + idx * 0.5}s ease-in-out infinite` }}>
                            <div className="w-16 h-16 sm:w-32 sm:h-32 rounded-2xl sm:rounded-[2.5rem] overflow-hidden mb-3 sm:mb-6 relative border border-white/10 bg-black/20">
                                <img src={lvl.image} className={`w-full h-full object-cover transition-opacity duration-700 ${collectedIds.includes(lvl.id) ? 'opacity-100 grayscale-0 scale-110' : 'opacity-40 grayscale'}`} alt={lvl.title} loading="lazy" />
                            </div>
                            <span className="text-[10px] sm:text-xs font-black text-emerald-300 mb-1 uppercase tracking-[0.1em]">{lvl.title}</span>
                            <h3 className="text-sm sm:text-xl font-black text-white">{lvl.subtitle}</h3>
                            {collectedIds.includes(lvl.id) && <div className="absolute -top-1.5 -right-1.5 bg-emerald-500 p-1 rounded-full text-white ring-2 ring-emerald-500/20"><Icon name="Sparkles" size={14} /></div>}
                        </button>
                    ))}
                </div>
            </div>
        );

        const GameEngine = ({ level, lives, setLives, onComplete, onBack }) => {
            const [shuffled, setShuffled] = useState([]);
            const [selected, setSelected] = useState([]);
            const [timeLeft, setTimeLeft] = useState(level.time);
            const [isFinished, setIsFinished] = useState(false);
            const [isReading, setIsReading] = useState(false);
            const [showFailure, setShowFailure] = useState(false);

            useEffect(() => {
                const arr = [...level.scripture].sort(() => Math.random() - 0.5);
                setShuffled(arr); setSelected([]); setTimeLeft(level.time); 
                setIsFinished(false); setShowFailure(false);
                return () => { window.speechSynthesis.cancel(); };
            }, [level]);

            useEffect(() => {
                if (timeLeft > 0 && !isFinished && !showFailure) {
                    const timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0 && !isFinished) {
                    setShowFailure(true);
                }
            }, [timeLeft, isFinished, showFailure]);

            const handlePhraseClick = (phrase) => {
                if (isFinished || isReading || showFailure) return;
                if (phrase === level.scripture[selected.length]) {
                    const nextSelected = [...selected, phrase];
                    setSelected(nextSelected);
                    setShuffled(prev => prev.filter(p => p !== phrase));
                    if (nextSelected.length === level.scripture.length) {
                        setIsFinished(true); onComplete(); 
                        setIsReading(true); speakText(level.full, () => setIsReading(false));
                    }
                } else {
                    const nextLives = lives - 1; setLives(nextLives);
                    if (nextLives <= 0) setShowFailure(true);
                }
            };

            return (
                <div className="flex-1 flex flex-col p-4 sm:p-10 animate-in fade-in duration-500 relative h-full overflow-hidden text-center">
                    <div className="flex justify-between items-center mb-6 px-2 sm:px-8">
                        <button onClick={onBack} className="bg-black/40 p-2 sm:px-6 sm:py-3 rounded-full border border-white/10 text-slate-300 hover:text-white transition-all flex items-center gap-1 active:scale-90">
                            <Icon name="RefreshCw" size={16} className="rotate-180" /> <span className="text-sm sm:text-base">é€€å‡º</span>
                        </button>
                        <div className="flex items-center gap-3 sm:gap-12">
                            <div className="flex gap-1.5 sm:gap-3">
                                {[...Array(3)].map((_, i) => (
                                    <div key={i} className={`transition-all duration-500 transform ${i < lives ? 'scale-100' : 'scale-50 opacity-20 rotate-45 grayscale'}`}>
                                        <Icon name="Leaf" size={24} className="text-emerald-400 fill-emerald-400/20" />
                                    </div>
                                ))}
                            </div>
                            <div className={`flex items-center gap-2 bg-black/40 px-3 py-1.5 sm:px-6 sm:py-3 rounded-full border-2 border-white/20 shadow-2xl ${timeLeft < 10 ? 'animate-pulse text-red-500' : 'text-white'}`}>
                                <Icon name="Timer" size={18} /><span className="text-lg sm:text-3xl font-black tabular-nums">{timeLeft}s</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center gap-4 sm:gap-10 overflow-y-auto px-2">
                        <div className="w-full max-w-4xl flex flex-wrap justify-center gap-2 sm:gap-4 min-h-[80px] bg-black/30 border border-white/10 p-4 sm:p-10 rounded-[2.5rem] shadow-xl">
                            {selected.map((p, i) => (
                                <div key={i} className="bg-emerald-600/80 text-white px-3 py-1.5 sm:px-8 sm:py-4 rounded-xl font-black text-sm sm:text-2xl animate-in zoom-in border border-emerald-400/50 shadow-lg">{p}</div>
                            ))}
                        </div>
                        {!isFinished && !showFailure && (
                            <div className="w-full max-w-4xl flex flex-wrap justify-center gap-2 sm:gap-6 pb-6">
                                {shuffled.map((p, i) => (
                                    <button key={i} onClick={() => handlePhraseClick(p)} className="bg-black/60 hover:bg-emerald-900/60 active:scale-90 text-emerald-50 px-4 py-2 sm:px-8 sm:py-5 rounded-xl border border-white/10 font-black text-sm sm:text-2xl shadow-lg">
                                        {p}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    {isFinished && (
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/95 backdrop-blur-3xl z-50 animate-in fade-in duration-700 p-6 text-center">
                            <div className="max-w-2xl">
                                <div className="w-20 h-20 sm:w-32 sm:h-32 bg-emerald-500/20 rounded-[2rem] flex items-center justify-center mb-6 border-2 border-emerald-400 mx-auto shadow-2xl animate-float-island text-emerald-400">
                                    <Icon name={isReading ? "Volume2" : "Sparkles"} size={40} className={isReading ? "animate-pulse" : ""} />
                                </div>
                                <h2 className="text-3xl sm:text-5xl font-black text-emerald-300 mb-6 tracking-[0.3em] uppercase">ä¿®è¡Œè¦ºé†’</h2>
                                <div className="bg-white/5 p-6 sm:p-16 rounded-[2rem] border border-white/10 shadow-2xl mb-8">
                                   <p className="text-lg sm:text-4xl font-black text-white leading-relaxed italic" style={{ fontFamily: 'Noto Serif TC' }}>ã€Œ{level.full}ã€</p>
                                </div>
                                <button onClick={onBack} disabled={isReading} className={`bg-white text-slate-900 px-10 py-3 sm:px-20 sm:py-6 rounded-full font-black text-lg sm:text-3xl shadow-2xl transition-all active:scale-95 flex items-center gap-4 mx-auto ${isReading ? 'opacity-50 cursor-wait' : ''}`}>
                                    è¿”å›ä¿®è¡Œ <Icon name="ChevronRight" size={24} className="text-slate-900" />
                                </button>
                            </div>
                        </div>
                    )}
                    {showFailure && (
                        <div className="absolute inset-0 flex flex-col items-center justify-center bg-red-950/95 backdrop-blur-3xl z-50 animate-in fade-in p-6 text-center">
                            <Icon name="AlertCircle" size={80} className="text-red-500 mb-4 animate-bounce" />
                            <h2 className="text-4xl sm:text-7xl font-black text-white mb-4 tracking-tighter">å¿ƒç¥å·²äº‚</h2>
                            <p className="text-lg sm:text-2xl text-red-200 mb-10 font-light text-white">ä¿®è¡Œå°šæœªç©©å›ºï¼Œè«‹é‡æ–°å®šå¿ƒå†è©¦ã€‚</p>
                            <button onClick={onBack} className="bg-white text-slate-900 px-12 py-4 rounded-full font-black text-xl sm:text-3xl active:scale-95 shadow-2xl">é‡æ–°å®šå¿ƒ</button>
                        </div>
                    )}
                </div>
            );
        };

        const DedicationScene = ({ onFinish, onBack }) => {
            const [groupStep, setGroupStep] = useState(0); 
            const [interactionMode, setInteractionMode] = useState('memorize'); 
            const [correctSequence, setCorrectSequence] = useState([]);
            const [shuffledStars, setShuffledStars] = useState([]);
            const [isReading, setIsReading] = useState(false);
            const [errorStar, setErrorStar] = useState(null);

            const bgFireflies = useMemo(() => {
                return [...Array(25)].map((_, i) => ({
                    id: i,
                    x: Math.random() * 100,
                    y: Math.random() * 100,
                    size: 2 + Math.random() * 4,
                    duration: 3 + Math.random() * 3 + "s",
                    delay: Math.random() * 4 + "s"
                }));
            }, []);

            const generateSafeStars = (group, isMobile) => {
                const stars = [];
                const minDistance = isMobile ? 22 : 18; 
                for (let i = 0; i < group.phrases.length; i++) {
                    let x, y, tooClose;
                    let attempts = 0;
                    do {
                        tooClose = false;
                        x = (isMobile ? 12 : 8) + Math.random() * (isMobile ? 70 : 82);
                        y = (isMobile ? 20 : 18) + Math.random() * (isMobile ? 55 : 62);
                        for (let j = 0; j < stars.length; j++) {
                            const dx = x - stars[j].x;
                            const dy = y - stars[j].y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < minDistance) { tooClose = true; break; }
                        }
                        attempts++;
                    } while (tooClose && attempts < 40); 
                    stars.push({ id: i, text: group.phrases[i], x, y, delay: `${Math.random() * -10}s`, duration: `${12 + Math.random() * 6}s` });
                }
                return stars;
            };

            useEffect(() => {
                if (groupStep >= SCRIPTURE_EPILOGUE_GROUPS.length) return;
                const group = SCRIPTURE_EPILOGUE_GROUPS[groupStep];
                const isMobile = window.innerWidth < 640;
                const stars = generateSafeStars(group, isMobile);
                setShuffledStars([...stars].sort(() => Math.random() - 0.5));
                setCorrectSequence([]);
                setInteractionMode('memorize');
                const timer = setTimeout(() => setInteractionMode('link'), 3500);
                return () => clearTimeout(timer);
            }, [groupStep]);

            const handleStarClick = (star) => {
                if (interactionMode !== 'link' || isReading) return;
                const group = SCRIPTURE_EPILOGUE_GROUPS[groupStep];
                if (star.text === group.phrases[correctSequence.length]) {
                    const newSequence = [...correctSequence, star.text];
                    setCorrectSequence(newSequence);
                    if (newSequence.length === group.phrases.length) {
                        setIsReading(true);
                        speakText(group.full, () => {
                            setIsReading(false);
                            if (groupStep < SCRIPTURE_EPILOGUE_GROUPS.length - 1) setGroupStep(groupStep + 1);
                            else { setInteractionMode('finished'); setTimeout(onFinish, 2000); }
                        });
                    }
                } else {
                    setErrorStar(star.id);
                    setTimeout(() => setErrorStar(null), 500);
                }
            };

            const currentGroup = SCRIPTURE_EPILOGUE_GROUPS[groupStep];

            return (
                <div className="flex-1 flex flex-col items-center justify-center p-4 sm:p-20 animate-in fade-in duration-1000 relative h-full overflow-hidden text-center">
                    <div className="absolute inset-0 bg-gradient-to-br from-emerald-950/40 via-[#020617] to-amber-950/40 backdrop-blur-2xl pointer-events-none">
                        {bgFireflies.map(f => (
                            <div key={f.id} className="absolute rounded-full bg-amber-200 animate-twinkle shadow-lg"
                                 style={{ left: `${f.x}%`, top: `${f.y}%`, width: `${f.size}px`, height: `${f.size}px`, '--duration': f.duration, animationDelay: f.delay }} 
                            />
                        ))}
                    </div>
                    <div className="absolute top-6 left-6 z-50">
                         <button onClick={onBack} className="bg-white/10 p-3 sm:px-6 sm:py-3 rounded-full border border-white/20 text-white flex items-center gap-2 active:scale-90">
                            <Icon name="X" size={20} className="text-white" /> <span className="hidden sm:inline">é€€å‡º</span>
                        </button>
                    </div>
                    <div className="relative z-10 w-full h-full flex flex-col items-center">
                        <header className="mb-4 sm:mb-12">
                            <h2 className="text-3xl sm:text-5xl font-black text-amber-200 tracking-[0.3em] mb-2 uppercase text-shadow-md">åœ“æ»¿è¦ºçŸ¥</h2>
                            <div className="inline-block px-6 py-1.5 rounded-full border border-emerald-500/30 bg-emerald-500/10 backdrop-blur-md">
                                <p className="text-emerald-300 font-bold tracking-widest text-[11px] sm:text-lg">
                                    {interactionMode === 'memorize' ? "è‡³å¿ƒå‡è¦– Â· éŠ˜åˆ»æ™ºæ…§" : isReading ? "æ³•éŸ³æµè½‰ Â· è¦ºæ€§æ˜‡è¯" : "æ–‡å­—å¦‚è¢ Â· è«‹ä¾åºé»é¸"}
                                </p>
                            </div>
                        </header>
                        <div className="flex-1 w-full relative min-h-[300px]">
                            {interactionMode === 'memorize' ? (
                                <div className="absolute inset-0 flex items-center justify-center animate-in fade-in zoom-in duration-700 p-4">
                                    <div className="bg-black/40 p-6 sm:p-16 rounded-[2rem] border-2 border-amber-500/20 shadow-2xl">
                                        <p className="text-xl sm:text-5xl font-black text-amber-100 leading-relaxed italic" style={{ fontFamily: 'Noto Serif TC' }}>ã€Œ{currentGroup.full}ã€</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="w-full h-full relative">
                                    {shuffledStars.map((star) => {
                                        const isCorrect = correctSequence.includes(star.text);
                                        return (
                                            <div key={star.id} onClick={() => handleStarClick(star)} className={`absolute cursor-pointer transition-all duration-700 transform flex flex-col items-center group ${isCorrect ? 'scale-110 opacity-100' : 'hover:scale-125'} ${errorStar === star.id ? 'animate-shake' : ''} ${!isCorrect ? 'animate-star-float' : ''}`} style={{ left: `${star.x}%`, top: `${star.y}%`, animationDelay: star.delay, animationDuration: star.duration }}>
                                                <div className={`w-3 h-3 sm:w-5 sm:h-5 rounded-full mb-1.5 transition-all duration-500 ${isCorrect ? 'bg-amber-400 shadow-xl scale-150' : 'bg-white/40 shadow-md'}`}></div>
                                                <div className={`px-4 py-2 sm:px-10 sm:py-6 rounded-xl sm:rounded-[2.5rem] border transition-all duration-500 font-black text-xl sm:text-4xl backdrop-blur-md shadow-2xl ${isCorrect ? 'bg-amber-500/30 border-amber-400 text-amber-200' : 'bg-black/40 border-white/10 text-white/90'}`}>{star.text}</div>
                                            </div>
                                        );
                                    })}
                                    {isReading && (
                                        <div className="absolute bottom-0 w-full animate-in slide-in-from-bottom duration-1000 p-4">
                                            <div className="bg-emerald-950/60 px-6 py-6 sm:px-12 sm:py-10 rounded-2xl border-2 border-emerald-500/30 shadow-2xl backdrop-blur-xl">
                                                <p className="text-lg sm:text-4xl font-black text-white italic drop-shadow-lg">ã€Œ{currentGroup.full}ã€</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        {interactionMode === 'link' && !isReading && (
                            <div className="absolute bottom-10 w-full animate-pulse text-center">
                                <p className="text-amber-200/60 text-xs sm:text-sm tracking-[0.2em]">è«‹ä¾åºé»é¸ç¶“æ–‡ç‰‡èª</p>
                            </div>
                        )}
                        <div className="mt-4 sm:mt-12 flex gap-4">
                            {[0, 1, 2, 3, 4].map(i => (
                                <div key={i} className={`w-3 h-3 rounded-full border border-white/20 transition-all duration-700 ${i < groupStep ? 'bg-emerald-400' : i === groupStep ? 'bg-amber-400 animate-pulse' : 'bg-white/5'}`} />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const JournalView = ({ levels, collectedIds, onClose, isDedicationDone }) => (
            <div className="flex-1 flex flex-col p-6 sm:p-14 animate-in slide-in-from-right duration-500 overflow-hidden relative text-white h-full text-center">
                <header className="mb-6 sm:mb-12 flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-white/20 pb-6 sm:pb-10">
                    <div className="text-center sm:text-left">
                        <h2 className="text-4xl sm:text-7xl font-black bg-clip-text text-transparent bg-gradient-to-r from-amber-200 via-amber-400 to-amber-600 tracking-tighter">æ™ºæ…§æ‰‹æœ­</h2>
                        <p className="text-slate-300 mt-2 font-bold tracking-[0.4em] uppercase text-[10px] sm:text-lg">Treasury of Eight Realizations</p>
                    </div>
                    <button onClick={onClose} className="bg-black/50 hover:bg-black/70 px-8 py-2 sm:py-4 rounded-full border-2 border-white/20 font-black text-lg sm:text-2xl transition-all active:scale-95">è¿”å›åœ°åœ–</button>
                </header>
                <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 sm:pr-8 space-y-6 pb-20">
                    {collectedIds.length === 0 && !isDedicationDone ? (
                        <div className="h-full flex flex-col items-center justify-center text-slate-400 italic">
                            <Icon name="ScrollText" size={80} className="mb-4 opacity-10 animate-pulse mx-auto text-white" />
                            <p className="text-xl sm:text-2xl tracking-[0.3em]">æ‰‹æœ­ç©ºç©ºï¼Œå¾…æ‚¨å…¥æ—ä¿®è¡Œ</p>
                        </div>
                    ) : (
                        <>
                            {levels.filter(l => collectedIds.includes(l.id)).map((level) => (
                                <div key={level.id} className="bg-black/40 p-5 sm:p-16 rounded-[2rem] border border-white/10 shadow-xl">
                                    <div className="flex items-center gap-4 sm:gap-10 mb-5 sm:mb-12">
                                        <div className="w-14 h-14 sm:w-28 sm:h-28 rounded-xl sm:rounded-3xl overflow-hidden border-2 border-amber-500/40">
                                            <img src={level.image} className="w-full h-full object-cover" alt={level.title} />
                                        </div>
                                        <div className="text-left">
                                            <span className="text-[10px] sm:text-sm font-black text-amber-50 uppercase tracking-[0.1em] mb-1 block">{level.title}</span>
                                            <h4 className="text-xl sm:text-5xl font-black text-white tracking-widest">{level.subtitle}</h4>
                                        </div>
                                    </div>
                                    <p className="text-base sm:text-4xl font-black text-emerald-50 leading-relaxed italic" style={{ fontFamily: 'Noto Serif TC' }}>ã€Œ{level.full}ã€</p>
                                </div>
                            ))}
                            {isDedicationDone && (
                                <div className="bg-amber-950/40 p-5 sm:p-16 rounded-[2rem] border border-amber-500/30 shadow-xl mt-6 relative overflow-hidden">
                                   <div className="flex items-center justify-center mb-5">
                                     <div className="w-14 h-14 sm:w-28 sm:h-28 rounded-full bg-amber-600/20 flex items-center justify-center border-2 border-amber-400 mx-auto">
                                       <Icon name="Waves" size={30} className="text-amber-400" />
                                     </div>
                                   </div>
                                   <p className="text-base sm:text-4xl font-black text-amber-50 leading-relaxed italic" style={{ fontFamily: 'Noto Serif TC' }}>ã€Œ{SCRIPTURE_OUTRO}ã€</p>
                                </div>
                            )}
                        </>
                    )}
                </div>
            </div>
        );

        const FinalResult = ({ levels, onRestart }) => (
            <div className="flex-1 flex flex-col p-4 sm:p-14 overflow-y-auto custom-scrollbar animate-in fade-in duration-1000 text-white h-full text-center">
                <header className="text-center mb-10 sm:mb-20">
                    <div className="text-6xl sm:text-9xl mb-6 animate-float-island text-emerald-400 mx-auto flex justify-center">ğŸŒ³</div>
                    <h1 className="text-4xl sm:text-8xl lg:text-9xl font-black tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-emerald-200 via-teal-100 to-blue-400 mb-4">å…«è¦ºåœ“æ»¿</h1>
                    <p className="text-sm sm:text-3xl lg:text-4xl text-slate-100 font-light tracking-[0.1em] max-w-4xl mx-auto leading-relaxed">å–„å“‰ï¼è¦ºçŸ¥å·²æˆåƒå¤©å¤§æ¨¹ï¼Œæ™ºæ…§æ°¸é§æ–¼å¿ƒã€‚</p>
                </header>
                <div className="max-w-6xl mx-auto space-y-10 mb-32">
                    <div className="bg-black/40 p-6 sm:p-20 rounded-[2.5rem] border border-emerald-500/30">
                        <h3 className="text-emerald-400 font-black mb-8 sm:mb-16 tracking-[0.5em] uppercase text-lg sm:text-2xl border-b border-emerald-500/20 pb-6 italic">ä½›èªªå…«å¤§äººè¦ºç¶“ Â· åœ“æ»¿ç¸½è¦½</h3>
                        <div className="space-y-8 sm:space-y-20">
                            {levels.map((lvl) => (
                                <div key={lvl.id} className="space-y-4 sm:space-y-8 px-2 sm:px-10 text-left">
                                    <div className="flex items-center gap-4 sm:gap-8 text-white"><span className="w-8 h-8 sm:w-16 sm:h-16 rounded-full bg-emerald-500/20 flex items-center justify-center text-sm sm:text-2xl text-emerald-200 font-black border border-emerald-500/40">{lvl.id}</span><span className="text-xl sm:text-4xl font-black text-emerald-300 tracking-[0.1em]">{lvl.subtitle}</span></div>
                                    <p className="text-lg sm:text-3xl font-bold text-white italic leading-relaxed pl-10 border-l-4 border-emerald-500/20">ã€Œ{lvl.full}ã€</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="bg-black/50 p-6 sm:p-24 rounded-[2.5rem] border border-white/20 shadow-2xl backdrop-blur-xl">
                        <p className="text-lg sm:text-4xl text-white leading-relaxed md:leading-[2.4] font-light whitespace-pre-wrap italic">ã€Œ{SCRIPTURE_OUTRO}ã€</p>
                    </div>
                </div>
                <button onClick={onRestart} className="bg-white text-slate-900 px-10 py-4 sm:px-32 sm:py-10 rounded-full font-black text-xl sm:text-5xl shadow-2xl mx-auto flex items-center gap-6 active:scale-95 mb-32">
                    <Icon name="RefreshCw" size={28} className="text-slate-900" /> é‡æ–°ä¿®å¿ƒ
                </button>
            </div>
        );

        function App() {
            const [view, setView] = useState('start');
            const [collectedIds, setCollectedIds] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [lives, setLives] = useState(3);
            const [isDedicationDone, setIsDedicationDone] = useState(false);
            const bgmRef = useRef(null);
            const audioContextRef = useRef(null);

            const playBgm = (url) => {
                if (bgmRef.current) bgmRef.current.pause();
                bgmRef.current = new Audio(url); bgmRef.current.loop = true; bgmRef.current.volume = 0.2;
                bgmRef.current.play().catch(() => {});
            };

            return (
                <div className="min-h-screen relative overflow-hidden flex items-center justify-center w-full">
                    <div className="absolute inset-0 z-0 select-none pointer-events-none">
                        <img src="https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&q=80&w=1600" className="w-full h-full object-cover opacity-60 scale-105" alt="èƒŒæ™¯" />
                        <div className="absolute inset-0 bg-gradient-to-b from-black/70 via-transparent to-black/80"></div>
                        <div className="absolute inset-0 overflow-hidden">
                            {[...Array(8)].map((_, i) => (
                                <div key={i} className="absolute rounded-full bg-emerald-400/20 blur-xl animate-firefly"
                                    style={{ width: Math.random()*80+40+'px', height: Math.random()*80+40+'px', top: Math.random()*100+'%', left: Math.random()*100+'%', animationDuration: Math.random()*8+10+'s', animationDelay: `${Math.random()*5}s` }}
                                />
                            ))}
                        </div>
                    </div>

                    <div className="relative z-10 w-full max-w-6xl h-[94vh] sm:h-[92vh] max-h-[850px] mx-2 sm:mx-4 overflow-hidden flex flex-col transition-all duration-500 text-white">
                        {view === 'start' && <StartScreen onStart={() => setView('map')} />}
                        {view === 'map' && (
                            <MapView levels={LEVELS} collectedIds={collectedIds} onSelect={(idx) => { setCurrentIdx(idx); setLives(3); setView('playing'); playBgm(LEVELS[idx].bgm); }} onOpenJournal={() => setView('journal')} onFinal={() => { setView('dedication'); playBgm('https://jamiejenjen0305.github.io/MED/8-1.mp3'); }} isDedicationDone={isDedicationDone} />
                        )}
                        {view === 'playing' && (
                            <GameEngine level={LEVELS[currentIdx]} lives={lives} setLives={setLives} onComplete={() => setCollectedIds(prev => Array.from(new Set([...prev, LEVELS[currentIdx].id])))} onBack={() => { if(bgmRef.current) bgmRef.current.pause(); window.speechSynthesis.cancel(); setView('map'); }} />
                        )}
                        {view === 'journal' && <JournalView levels={LEVELS} collectedIds={collectedIds} onClose={() => setView('map')} isDedicationDone={isDedicationDone} />}
                        {view === 'dedication' && (
                            <DedicationScene onFinish={() => { setIsDedicationDone(true); setView('result'); }} onBack={() => { if(bgmRef.current) bgmRef.current.pause(); window.speechSynthesis.cancel(); setView('map'); }} />
                        )}
                        {view === 'result' && <FinalResult levels={LEVELS} onRestart={() => setView('map')} />}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>